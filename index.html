<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SketchCrew ‚Äî Tebak Gambar Multiplayer</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:        #0d0f14;
      --surface:   #161922;
      --surface2:  #1e2230;
      --border:    #2a2f42;
      --accent:    #6c63ff;
      --accent2:   #ff6584;
      --green:     #43e97b;
      --gold:      #ffd166;
      --text:      #e8eaf2;
      --muted:     #6b7194;
      --radius:    14px;
      --radius-sm: 8px;
      --shadow:    0 8px 40px rgba(0,0,0,.55);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
    .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
    .screen.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }

    /* ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ */
    #lobby-screen {
      background: radial-gradient(ellipse 80% 60% at 50% -10%, rgba(108,99,255,.18) 0%, transparent 70%), var(--bg);
      padding: 24px 16px;
    }
    .lobby-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 24px; padding: 36px 32px;
      width: 100%; max-width: 440px;
      box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 22px;
    }
    .logo { text-align: center; }
    .logo h1 {
      font-family: 'Syne', sans-serif; font-weight: 800; font-size: 2.2rem; letter-spacing: -1px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .logo p { color: var(--muted); font-size: .85rem; margin-top: 4px; }
    .divider { height: 1px; background: var(--border); }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-size: .78rem; font-weight: 500; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }
    input[type="text"] {
      width: 100%; padding: 12px 16px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: var(--radius-sm); color: var(--text);
      font-family: 'DM Sans', sans-serif; font-size: .95rem;
      outline: none; transition: border-color .2s;
    }
    input[type="text"]:focus { border-color: var(--accent); }
    input[type="text"]::placeholder { color: var(--muted); }
    .btn {
      padding: 13px 20px; border: none; border-radius: var(--radius-sm); cursor: pointer;
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: .9rem;
      letter-spacing: .02em; transition: all .18s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: #5a52e0; transform: translateY(-1px); box-shadow: 0 6px 24px rgba(108,99,255,.4); }
    .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border); }
    .btn-green { background: var(--green); color: #0d0f14; font-family: 'Syne', sans-serif; font-weight: 700; }
    .btn-green:hover { background: #32d46a; transform: translateY(-1px); }
    .btn:disabled { opacity: .45; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
    .btn-group { display: flex; gap: 10px; }
    .btn-group .btn { flex: 1; }
    .error-msg { color: var(--accent2); font-size: .82rem; min-height: 18px; }

    /* ‚îÄ‚îÄ WAITING ROOM ‚îÄ‚îÄ */
    #waiting-screen {
      padding: 24px 16px;
      background: radial-gradient(ellipse 60% 50% at 80% 20%, rgba(255,101,132,.1) 0%, transparent 60%), var(--bg);
    }
    .waiting-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 24px; padding: 28px 26px;
      width: 100%; max-width: 480px;
      box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 20px;
    }
    .room-header { display: flex; align-items: center; justify-content: space-between; }
    .room-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.3rem; }
    .room-code-badge {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 40px; padding: 6px 18px;
      font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.2rem;
      color: var(--gold); cursor: pointer; display: flex; align-items: center; gap: 8px;
      letter-spacing: .2em; transition: background .2s;
    }
    .room-code-badge:hover { background: var(--border); }
    .players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
    .player-card-mini {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: var(--radius-sm); padding: 12px 14px;
      display: flex; align-items: center; gap: 10px;
    }
    .avatar {
      width: 34px; height: 34px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: .85rem; flex-shrink: 0;
    }
    .player-card-mini .pname { font-size: .82rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .host-tag { font-size: .6rem; background: var(--gold); color: var(--bg); border-radius: 4px; padding: 1px 5px; font-weight: 700; text-transform: uppercase; }
    .waiting-status { text-align: center; color: var(--muted); font-size: .85rem; }

    /* ‚îÄ‚îÄ THEME PICKER MODAL ‚îÄ‚îÄ */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.8);
      display: flex; align-items: center; justify-content: center;
      z-index: 200; padding: 20px;
    }
    .modal-backdrop.hidden { display: none; }
    .modal-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 22px; padding: 28px 24px;
      width: 100%; max-width: 420px;
      box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 18px;
      animation: modal-in .22s ease both;
    }
    @keyframes modal-in { from { transform: scale(.93); opacity: 0; } to { transform: none; opacity: 1; } }
    .modal-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.25rem; text-align: center; }
    .modal-sub { color: var(--muted); font-size: .83rem; text-align: center; margin-top: -8px; }
    .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .random-btn {
      grid-column: span 2;
      background: linear-gradient(135deg, rgba(108,99,255,.15), rgba(255,101,132,.1));
      border: 2px solid rgba(108,99,255,.35);
      border-radius: var(--radius-sm); padding: 14px;
      text-align: center; cursor: pointer;
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: .95rem;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      transition: all .15s;
    }
    .random-btn:hover, .random-btn.sel { border-color: var(--accent); background: rgba(108,99,255,.2); }
    .theme-btn {
      background: var(--surface2); border: 2px solid var(--border);
      border-radius: var(--radius-sm); padding: 14px 10px;
      text-align: center; cursor: pointer;
      display: flex; flex-direction: column; gap: 4px;
      transition: all .15s;
    }
    .theme-btn:hover, .theme-btn.sel { border-color: var(--accent); background: rgba(108,99,255,.1); }
    .theme-btn .t-emoji { font-size: 1.5rem; }
    .theme-btn .t-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: .8rem; }
    .theme-btn .t-count { font-size: .68rem; color: var(--muted); }

    /* ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ */
    #game-screen { width: 100%; height: 100%; display: none; flex-direction: column; background: var(--bg); overflow: hidden; }
    #game-screen.active { display: flex; }

    .game-topbar {
      flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; background: var(--surface); border-bottom: 1px solid var(--border); gap: 10px;
    }
    .topbar-left, .topbar-right { display: flex; align-items: center; gap: 10px; flex: 1; }
    .topbar-right { justify-content: flex-end; }
    .round-badge {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 40px; padding: 4px 12px; font-size: .75rem; font-weight: 600;
      color: var(--muted); font-family: 'Syne', sans-serif;
    }
    .theme-badge {
      background: rgba(108,99,255,.15); border: 1px solid rgba(108,99,255,.3);
      border-radius: 40px; padding: 4px 12px; font-size: .75rem; font-weight: 600;
      color: var(--accent); font-family: 'Syne', sans-serif;
    }
    .timer-ring-wrap { position: relative; width: 44px; height: 44px; flex-shrink: 0; }
    #timer-svg { position: absolute; top: 0; left: 0; transform: rotate(-90deg); }
    #timer-circle {
      fill: none; stroke: var(--accent); stroke-width: 3;
      stroke-linecap: round; stroke-dasharray: 120; stroke-dashoffset: 0;
      transition: stroke-dashoffset 1s linear, stroke .4s;
    }
    .timer-number {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      font-family: 'Syne', sans-serif; font-weight: 800; font-size: .95rem;
    }

    .game-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .canvas-wrap { flex: 1; position: relative; min-height: 0; background: #1a1d26; overflow: hidden; }
    #game-canvas { display: block; width: 100%; height: 100%; cursor: crosshair; touch-action: none; }

    .word-hint-bar {
      position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 6px; align-items: center; pointer-events: none;
      flex-wrap: wrap; justify-content: center; max-width: 92%;
    }
    .hint-letter {
      width: 22px; height: 28px; background: rgba(14,16,20,.75);
      border-bottom: 2px solid var(--text);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem;
      color: var(--text); border-radius: 3px;
    }
    .hint-letter.revealed { background: rgba(67,233,123,.12); border-bottom-color: var(--green); color: var(--green); }

    .drawer-word-bar {
      position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
      background: rgba(13,15,20,.9); border: 1px solid var(--accent);
      border-radius: 40px; padding: 6px 20px;
      font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1rem;
      color: var(--accent); pointer-events: none; white-space: nowrap; backdrop-filter: blur(8px);
    }

    .phase-overlay {
      position: absolute; inset: 0; background: rgba(13,15,20,.92);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 14px; z-index: 10;
    }
    .phase-overlay.hidden { display: none; }
    .phase-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.8rem; text-align: center; }
    .phase-sub { color: var(--muted); font-size: .9rem; text-align: center; max-width: 290px; line-height: 1.7; }
    .phase-word { font-family: 'Syne', sans-serif; font-size: 2rem; font-weight: 800; color: var(--gold); letter-spacing: 2px; text-align: center; }
    .phase-countdown { font-family: 'Syne', sans-serif; font-weight: 700; font-size: .88rem; color: var(--muted); }

    .draw-toolbar {
      flex-shrink: 0; display: flex; align-items: center; gap: 10px;
      padding: 8px 12px; background: var(--surface); border-top: 1px solid var(--border);
      overflow-x: auto; scrollbar-width: none;
    }
    .draw-toolbar::-webkit-scrollbar { display: none; }
    .color-swatch {
      width: 28px; height: 28px; border-radius: 50%;
      border: 2px solid transparent; cursor: pointer; flex-shrink: 0;
      transition: transform .15s, border-color .15s;
    }
    .color-swatch:hover { transform: scale(1.18); }
    .color-swatch.active { border-color: var(--text); transform: scale(1.18); }
    .toolbar-sep { width: 1px; height: 28px; background: var(--border); flex-shrink: 0; }
    .tool-btn {
      background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm);
      color: var(--text); width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; flex-shrink: 0; font-size: 1rem; transition: background .15s, border-color .15s;
    }
    .tool-btn:hover { background: var(--border); }
    .tool-btn.active { background: rgba(108,99,255,.2); border-color: var(--accent); }
    .size-slider {
      -webkit-appearance: none; appearance: none;
      height: 4px; background: var(--border); border-radius: 2px;
      width: 80px; flex-shrink: 0; outline: none;
    }
    .size-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; }
    .size-slider::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; border: none; }

    .bottom-section {
      flex-shrink: 0; display: flex;
      height: 30vh; min-height: 160px; max-height: 280px;
      border-top: 1px solid var(--border); background: var(--surface); overflow: hidden;
    }
    .scoreboard { width: 130px; flex-shrink: 0; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
    .section-title {
      padding: 8px 12px; font-size: .7rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: .07em; color: var(--muted);
      border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .player-list { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
    .player-row {
      display: flex; align-items: center; gap: 8px; padding: 6px 10px;
      border-bottom: 1px solid rgba(42,47,66,.5); transition: background .15s;
    }
    .player-row:hover { background: var(--surface2); }
    .player-row .avatar { width: 26px; height: 26px; font-size: .7rem; flex-shrink: 0; }
    .player-row .pinfo { flex: 1; min-width: 0; }
    .player-row .pname { font-size: .78rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .player-row .pscore { font-family: 'Syne', sans-serif; font-weight: 700; font-size: .8rem; color: var(--gold); flex-shrink: 0; }
    .drawer-indicator { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; flex-shrink: 0; }

    .chat-panel { flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden; }
    .chat-messages {
      flex: 1; overflow-y: auto; padding: 8px 10px;
      display: flex; flex-direction: column; gap: 4px;
      scrollbar-width: thin; scrollbar-color: var(--border) transparent;
    }
    .chat-msg { font-size: .8rem; line-height: 1.4; word-break: break-word; }
    .chat-msg .cn { font-weight: 600; margin-right: 4px; }
    .chat-msg.correct { background: rgba(67,233,123,.09); border-left: 2px solid var(--green); padding: 4px 8px; border-radius: 4px; color: var(--green); }
    .chat-msg.system { color: var(--muted); font-style: italic; font-size: .75rem; }
    .chat-input-row { display: flex; gap: 8px; padding: 8px 10px; border-top: 1px solid var(--border); flex-shrink: 0; }
    .chat-input-row input { flex: 1; padding: 8px 12px; font-size: .82rem; border-radius: 20px; }
    .chat-input-row .btn { padding: 8px 14px; font-size: .8rem; border-radius: 20px; }

    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(60px);
      background: var(--surface); border: 1px solid var(--border); border-radius: 40px;
      padding: 10px 22px; font-size: .85rem; font-weight: 500; color: var(--text);
      box-shadow: var(--shadow); transition: transform .3s ease; z-index: 999; white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    #loading-screen { background: var(--bg); color: var(--muted); font-size: .9rem; gap: 12px; }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @keyframes correct-flash { 0%{box-shadow:0 0 0 0 rgba(67,233,123,.6)} 70%{box-shadow:0 0 0 18px rgba(67,233,123,0)} 100%{box-shadow:0 0 0 0 rgba(67,233,123,0)} }
    .canvas-wrap.flash { animation: correct-flash .65s ease; }

    @keyframes canvas-wipe { 0%{opacity:1} 40%{opacity:.2} 100%{opacity:1} }
    .canvas-wrap.wiping { animation: canvas-wipe .35s ease; }

    @media (min-width: 600px) { .scoreboard { width: 160px; } .bottom-section { height: 28vh; } }
    @keyframes hint-in { from{transform:translateY(4px);opacity:0} to{transform:none;opacity:1} }
    .hint-letter.revealed { animation: hint-in .2s ease both; }
  </style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen" class="screen active">
  <div class="spinner"></div>
  <span>Menghubungkan‚Ä¶</span>
</div>

<!-- LOBBY -->
<div id="lobby-screen" class="screen">
  <div class="lobby-card">
    <div class="logo">
      <h1>‚úèÔ∏è SketchCrew</h1>
      <p>Multiplayer tebak gambar realtime</p>
    </div>
    <div class="divider"></div>
    <div class="form-group">
      <label>Nama pemain</label>
      <input id="player-name" type="text" placeholder="Masukkan nama kamu‚Ä¶" maxlength="16" autocomplete="off" />
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" id="btn-create">Buat Room</button>
    </div>
    <div class="divider"></div>
    <div class="form-group">
      <label>Kode room (4 angka)</label>
      <input id="room-code-input" type="text" placeholder="Contoh: 4821" maxlength="4"
             autocomplete="off" inputmode="numeric" pattern="[0-9]*" style="letter-spacing:.25em;font-family:'Syne',sans-serif;font-weight:700;" />
    </div>
    <button class="btn btn-secondary" id="btn-join">Gabung Room</button>
    <div id="lobby-error" class="error-msg"></div>
  </div>
</div>

<!-- WAITING ROOM -->
<div id="waiting-screen" class="screen">
  <div class="waiting-card">
    <div class="room-header">
      <span class="room-title">Ruang Tunggu</span>
      <span class="room-code-badge" id="copy-code-btn" title="Klik untuk salin">
        üîë <span id="display-room-code">0000</span>
      </span>
    </div>
    <div class="players-grid" id="waiting-players"></div>
    <div class="waiting-status" id="waiting-status">Menunggu pemain lain‚Ä¶</div>
    <button class="btn btn-primary" id="btn-start" disabled>üé® Pilih Tema & Mulai</button>
  </div>
</div>

<!-- THEME PICKER MODAL -->
<div class="modal-backdrop hidden" id="theme-modal">
  <div class="modal-card">
    <div class="modal-title">üé® Pilih Tema Ronde</div>
    <div class="modal-sub">Host memilih kategori untuk ronde ini</div>
    <div class="theme-grid" id="theme-grid"></div>
    <div class="btn-group">
      <button class="btn btn-secondary" id="btn-cancel-theme">Batal</button>
      <button class="btn btn-green" id="btn-confirm-theme">‚ñ∂ Mulai Ronde!</button>
    </div>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="game-screen" class="screen">

  <div class="game-topbar">
    <div class="topbar-left">
      <span class="round-badge" id="round-label">Ronde 1</span>
      <span class="theme-badge" id="category-label">‚Äî</span>
    </div>
    <div class="timer-ring-wrap">
      <svg id="timer-svg" width="44" height="44">
        <circle id="timer-circle" cx="22" cy="22" r="19"/>
      </svg>
      <span class="timer-number" id="timer-number">60</span>
    </div>
    <div class="topbar-right">
      <span style="font-size:.78rem;color:var(--muted);" id="topbar-drawer-label">‚Äì</span>
    </div>
  </div>

  <div class="game-main">
    <div class="canvas-wrap" id="canvas-wrap">
      <canvas id="game-canvas"></canvas>
      <div class="drawer-word-bar" id="drawer-word-bar" style="display:none;"></div>
      <div class="word-hint-bar" id="word-hint-bar"></div>
      <div class="phase-overlay" id="phase-overlay">
        <div class="phase-title" id="phase-title">Bersiap‚Ä¶</div>
        <div class="phase-sub" id="phase-sub"></div>
        <div class="phase-word" id="phase-word" style="display:none;"></div>
        <div class="phase-countdown" id="phase-countdown"></div>
      </div>
    </div>

    <div class="draw-toolbar" id="draw-toolbar">
      <div class="color-swatch active" data-color="#ffffff" style="background:#ffffff;"></div>
      <div class="color-swatch" data-color="#f94144" style="background:#f94144;"></div>
      <div class="color-swatch" data-color="#f8961e" style="background:#f8961e;"></div>
      <div class="color-swatch" data-color="#ffd166" style="background:#ffd166;"></div>
      <div class="color-swatch" data-color="#43e97b" style="background:#43e97b;"></div>
      <div class="color-swatch" data-color="#4cc9f0" style="background:#4cc9f0;"></div>
      <div class="color-swatch" data-color="#6c63ff" style="background:#6c63ff;"></div>
      <div class="color-swatch" data-color="#ff6584" style="background:#ff6584;"></div>
      <div class="color-swatch" data-color="#a855f7" style="background:#a855f7;"></div>
      <div class="color-swatch" data-color="#fb923c" style="background:#fb923c;"></div>
      <div class="color-swatch" data-color="#0d0f14" style="background:#0d0f14;border:1px solid #2a2f42;"></div>
      <div class="toolbar-sep"></div>
      <div class="tool-btn" id="eraser-btn" title="Penghapus">üßπ</div>
      <input type="range" class="size-slider" id="size-slider" min="2" max="40" value="4" />
      <div class="toolbar-sep"></div>
      <div class="tool-btn" id="clear-btn" title="Bersihkan canvas">üóëÔ∏è</div>
    </div>

    <div class="bottom-section">
      <div class="scoreboard">
        <div class="section-title">Pemain</div>
        <div class="player-list" id="game-player-list"></div>
      </div>
      <div class="chat-panel">
        <div class="section-title">Chat & Tebakan</div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-row">
          <input type="text" id="chat-input" placeholder="Tebak atau ngobrol‚Ä¶" maxlength="60" autocomplete="off" />
          <button class="btn btn-primary" id="btn-send-chat">Kirim</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ============================================================
   FIREBASE CONFIG
   Struktur database:
   rooms/{roomId}/
     host, status, currentRound, maxRounds, currentDrawer,
     currentWord, currentCategory, roundStartTime,
     correctGuessers, drawerOrder, drawerIndex, roundId
     players/{pid}/ ‚Üí name, score, online
     chat/{pushId}/  ‚Üí playerName, message, isCorrect, isSystem, timestamp
     strokes/{pushId}/ ‚Üí x(0-1), y(0-1), state, color, size, eraser, ts
============================================================ */
const firebaseConfig = {
    apiKey: "AIzaSyAA5zPOoPgLkm4tHLYSZzk-OgkILxoeKwU",
    authDomain: "drawingpickgame.firebaseapp.com",
    databaseURL: "https://drawingpickgame-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "drawingpickgame",
    storageBucket: "drawingpickgame.firebasestorage.app",
    messagingSenderId: "1002361006200",
    appId: "1:1002361006200:web:e36aaf45bc0cfb6a32e58d",
    measurementId: "G-FYDN77LRBD"
  };

/* ============================================================
   WORD LISTS ‚Äî 8 kategori, 50+ kata tiap kategori
============================================================ */
const WORD_LISTS = {
  "üêæ Hewan": [
    "kucing","anjing","gajah","harimau","singa","burung","ikan","kuda","sapi","kerbau",
    "kelinci","monyet","beruang","rubah","pinguin","katak","ular","buaya","jerapah","zebra",
    "kanguru","koala","lumba-lumba","paus","hiu","elang","beo","merpati","cacing","laba-laba",
    "kura-kura","rusa","kambing","domba","babi","itik","ayam","angsa","merak","flamingo",
    "cheetah","serigala","badak","tapir","landak","berang-berang","musang","trenggiling","salamander","axolotl",
    "capung","belalang","semut","lebah","kupu-kupu","udang","kepiting","cumi-cumi","gurita","lobster"
  ],
  "üçú Makanan": [
    "nasi","mie","sate","bakso","rendang","tempe","tahu","pizza","burger","roti",
    "kue","coklat","es krim","sushi","nasi goreng","ayam goreng","gulai","soto","opor","lontong",
    "ketoprak","gado-gado","siomay","pecel","rujak","martabak","pempek","cendol","klepon","onde-onde",
    "donat","croissant","ramen","takoyaki","dim sum","hot dog","kebab","taco","pasta","lasagna",
    "mangga","pisang","apel","jeruk","durian","rambutan","salak","nanas","pepaya","alpukat",
    "es teh","kopi","jus jeruk","smoothie","bubble tea","wedang jahe","bajigur","susu","yogurt","keju"
  ],
  "ü™ë Benda": [
    "kursi","meja","lampu","pintu","jendela","buku","pensil","bolpoin","tas","sepatu",
    "jam","kaca","gelas","piring","sendok","garpu","komputer","hp","televisi","radio",
    "kipas","kulkas","oven","ember","payung","kunci","dompet","topi","kacamata","cermin",
    "bantal","selimut","kasur","lemari","sapu","sisir","gunting","palu","obeng","sekop",
    "charger","earphone","kamera","printer","joystick","keyboard","mouse","flashdisk","remote","senter",
    "termos","wajan","panci","talenan","blender","setrika","mesin cuci","AC","dispenser","kalkulator"
  ],
  "üë®‚Äç‚öïÔ∏è Profesi": [
    "dokter","guru","polisi","pilot","koki","petani","nelayan","arsitek","programmer","designer",
    "pelukis","musisi","atlet","penyanyi","aktor","penulis","fotografer","astronot","insinyur","bidan",
    "perawat","hakim","pengacara","tentara","pemadam kebakaran","sopir","kasir","pelayan","satpam","apoteker",
    "psikolog","veteriner","peneliti","ilmuwan","chef","barista","barber","stylist","model","jurnalis",
    "editor","sutradara","animator","arkeolog","diplomat","tukang listrik","tukang ledeng","mekanik","montir","pengemudi ojek"
  ],
  "üèùÔ∏è Tempat": [
    "sekolah","rumah sakit","pasar","mall","pantai","gunung","hutan","kota","desa","bandara",
    "pelabuhan","stasiun","masjid","gereja","candi","museum","perpustakaan","taman","kolam renang","bioskop",
    "restoran","hotel","kantor","pabrik","kebun binatang","stadion","universitas","puskesmas","terminal","apotek",
    "gua","air terjun","danau","sungai","padang pasir","savana","pulau","tebing","lembah","oasis",
    "pasar malam","taman bermain","panti asuhan","penjara","istana","benteng","mercusuar","rumah pohon","villa","resort"
  ],
  "üöó Transportasi": [
    "mobil","motor","sepeda","bus","truk","kereta","pesawat","kapal","helikopter","perahu",
    "becak","taksi","ambulans","pemadam","traktor","forklift","crane","bulldozer","ekskavator","skateboard",
    "skuter","bajaj","bemo","angkot","monorail","cable car","gondola","kapal selam","roket","balon udara",
    "jet ski","speedboat","kapal feri","kapal kargo","glider","sepeda listrik","motor listrik","ATV","sepeda gunung","gerobak"
  ],
  "‚öΩ Olahraga": [
    "sepak bola","basket","voli","tenis","badminton","renang","lari","tinju","gulat","panahan",
    "golf","bisbal","kriket","hoki","polo","rugby","skateboarding","surfing","diving","panjat tebing",
    "bersepeda","triathlon","maraton","sprint","lompat jauh","lempar cakram","tolak peluru","senam","yoga","pilates",
    "taekwondo","karate","judo","aikido","pencak silat","muay thai","boxing","wrestling","angkat besi","parkour",
    "esports","bowling","biliar","tenis meja","bulu tangkis","futsal","hockey es","curling","bobsled","ski"
  ],
  "üåç Alam & Cuaca": [
    "matahari","bulan","bintang","awan","hujan","pelangi","petir","tornado","gunung berapi","gempa bumi",
    "tsunami","banjir","salju","es","api","angin","kabut","embun","aurora","gerhana",
    "pohon","rumput","bunga","akar","daun","batu","tanah","lumpur","pasir","kerikil",
    "hutan hujan","terumbu karang","padang rumput","tundra","rawa","delta","ngarai","oasis","terasering","kawah",
    "koral","alga","lumut","pakis","kaktus","bunga matahari","mawar","melati","anggrek","bambu"
  ]
};

const CATEGORIES = Object.keys(WORD_LISTS);
const ROUND_DURATION  = 60;
const MAX_ROUNDS      = 8;
const CHAT_COOLDOWN   = 1200;
const ROUND_END_DELAY = 5000;

/* ============================================================ HELPERS */
const genId       = () => Math.floor(1000 + Math.random() * 9000).toString();
const genPid      = () => 'p_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
const pickRandom  = arr => arr[Math.floor(Math.random() * arr.length)];
const escHtml     = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const initials    = n => (n||'?').slice(0,2).toUpperCase();
function avatarColor(name) {
  const pal = ['#f94144','#f8961e','#6c63ff','#4cc9f0','#43e97b','#ff6584','#ffd166','#a855f7'];
  let h = 0; for (const c of name) h = (h*31 + c.charCodeAt(0)) & 0xffff;
  return pal[h % pal.length];
}

/* ============================================================ STATE */
let db;
let roomId=null, playerId=null, playerName=null;
let isHost=false, isDrawer=false;
let gameState={}, playersState={};
let currentWord='', currentCategory='';

// Canvas
let ctx, canvas, painting=false;
let curColor='#ffffff', brushSize=4, isEraser=false;
let strokesRef=null;
let prevRoundId=null;

// Chat
let lastChat=0;

// Timer
let timerInterval=null;

// Theme picker
let selTheme='__random__';
let pickerCtx='start';
let pendingSnap=null;

// Listeners
const listeners=[];
const addListener=(ref,ev,fn)=>{ ref.on(ev,fn); listeners.push({ref,ev,fn}); };
const clearListeners=()=>{ listeners.forEach(({ref,ev,fn})=>ref.off(ev,fn)); listeners.length=0; };

/* ============================================================ FIREBASE INIT */
function initFirebase() {
  try { firebase.initializeApp(firebaseConfig); db=firebase.database(); }
  catch(e) { console.error(e); }
  showScreen('lobby-screen');
}

/* ============================================================ UI UTILS */
function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function showError(m)  { document.getElementById('lobby-error').textContent=m; }
function showToast(m)  { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2400); }

/* ============================================================ LOBBY */
document.getElementById('btn-create').addEventListener('click', ()=>{
  const n=document.getElementById('player-name').value.trim();
  if(!n) return showError('Masukkan nama kamu dulu!');
  playerName=n; playerId=genPid(); createRoom();
});
document.getElementById('btn-join').addEventListener('click', ()=>{
  const n=document.getElementById('player-name').value.trim();
  const c=document.getElementById('room-code-input').value.trim();
  if(!n) return showError('Masukkan nama kamu dulu!');
  if(!/^\d{4}$/.test(c)) return showError('Kode room harus 4 angka!');
  playerName=n; playerId=genPid(); joinRoom(c);
});
document.getElementById('player-name').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('btn-create').click(); });
document.getElementById('room-code-input').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('btn-join').click(); });
document.getElementById('room-code-input').addEventListener('input', function(){ this.value=this.value.replace(/\D/g,'').slice(0,4); });

/* ============================================================ ROOM CREATE / JOIN */
async function createRoom() {
  if(!db) return showError('Firebase tidak terhubung!');
  roomId=genId(); isHost=true;
  await db.ref(`rooms/${roomId}`).set({ host:playerId, status:'waiting', currentRound:0, maxRounds:MAX_ROUNDS, currentDrawer:null, currentWord:null, currentCategory:null, roundStartTime:null, correctGuessers:null, roundId:null });
  await db.ref(`rooms/${roomId}/players/${playerId}`).set({ name:playerName, score:0, online:true });
  db.ref(`rooms/${roomId}/players/${playerId}/online`).onDisconnect().set(false);
  enterWaiting();
}
async function joinRoom(code) {
  if(!db) return showError('Firebase tidak terhubung!');
  const snap=await db.ref(`rooms/${code}`).once('value');
  if(!snap.exists()) return showError('Room tidak ditemukan!');
  if(snap.val().status!=='waiting') return showError('Game sudah berlangsung!');
  roomId=code; isHost=false;
  await db.ref(`rooms/${roomId}/players/${playerId}`).set({ name:playerName, score:0, online:true });
  db.ref(`rooms/${roomId}/players/${playerId}/online`).onDisconnect().set(false);
  enterWaiting();
}

/* ============================================================ WAITING ROOM */
function enterWaiting() {
  document.getElementById('display-room-code').textContent=roomId;
  showScreen('waiting-screen');
  addListener(db.ref(`rooms/${roomId}/players`), 'value', snap=>{ playersState=snap.val()||{}; renderWaitingPlayers(); updateStartBtn(); });
  addListener(db.ref(`rooms/${roomId}/status`), 'value', snap=>{ if(snap.val()==='drawing') enterGame(); });
  addListener(db.ref(`rooms/${roomId}/host`), 'value', snap=>{ isHost=snap.val()===playerId; updateStartBtn(); });
}

function renderWaitingPlayers() {
  const grid=document.getElementById('waiting-players'); grid.innerHTML='';
  db.ref(`rooms/${roomId}/host`).once('value', snap=>{
    const hostId=snap.val();
    Object.entries(playersState).forEach(([pid,p])=>{
      if(!p||!p.online) return;
      const col=avatarColor(p.name||'?');
      const d=document.createElement('div'); d.className='player-card-mini';
      d.innerHTML=`<div class="avatar" style="background:${col}20;color:${col};">${initials(p.name)}</div><div><div class="pname">${escHtml(p.name)}</div>${pid===hostId?'<div class="host-tag">Host</div>':''}</div>`;
      grid.appendChild(d);
    });
  });
}

function updateStartBtn() {
  const btn=document.getElementById('btn-start');
  const n=Object.values(playersState).filter(p=>p&&p.online).length;
  btn.disabled=!isHost||n<2;
  document.getElementById('waiting-status').textContent=isHost
    ?(n<2?`Butuh minimal 2 pemain (${n} terhubung)`:`${n} pemain siap ‚Äî klik Mulai!`)
    :`${n} pemain terhubung‚Ä¶ menunggu host`;
}

document.getElementById('btn-start').addEventListener('click', ()=>{ if(!isHost) return; pickerCtx='start'; openPicker(); });
document.getElementById('copy-code-btn').addEventListener('click', ()=>{ navigator.clipboard?.writeText(roomId).catch(()=>{}); showToast(`Kode "${roomId}" disalin! üìã`); });

/* ============================================================ THEME PICKER */
function buildPicker() {
  const grid=document.getElementById('theme-grid'); grid.innerHTML='';

  const rand=document.createElement('div');
  rand.className='random-btn'+(selTheme==='__random__'?' sel':'');
  rand.innerHTML='üé≤ Acak Otomatis';
  rand.onclick=()=>sel('__random__');
  grid.appendChild(rand);

  CATEGORIES.forEach(cat=>{
    const parts=cat.split(' ');
    const emoji=parts[0]; const name=parts.slice(1).join(' ');
    const d=document.createElement('div');
    d.className='theme-btn'+(selTheme===cat?' sel':'');
    d.innerHTML=`<span class="t-emoji">${emoji}</span><span class="t-name">${name}</span><span class="t-count">${WORD_LISTS[cat].length} kata</span>`;
    d.onclick=()=>sel(cat);
    grid.appendChild(d);
  });
}

function sel(val) {
  selTheme=val;
  document.querySelectorAll('.random-btn,.theme-btn').forEach(el=>el.classList.remove('sel'));
  if(val==='__random__') document.querySelector('.random-btn')?.classList.add('sel');
  else document.querySelectorAll('.theme-btn').forEach(el=>{
    const name=el.querySelector('.t-name')?.textContent;
    if(val.includes(name)) el.classList.add('sel');
  });
}

function openPicker() { selTheme='__random__'; buildPicker(); document.getElementById('theme-modal').classList.remove('hidden'); }
function closePicker() { document.getElementById('theme-modal').classList.add('hidden'); }
document.getElementById('btn-cancel-theme').addEventListener('click', closePicker);
document.getElementById('btn-confirm-theme').addEventListener('click', ()=>{
  closePicker();
  const cat=selTheme==='__random__'?pickRandom(CATEGORIES):selTheme;
  const word=pickRandom(WORD_LISTS[cat]);
  if(pickerCtx==='start') doStart(cat,word);
  else doNext(pendingSnap,cat,word);
});

/* ============================================================ GAME START / NEXT ROUND */
async function doStart(cat,word) {
  const players=Object.entries(playersState).filter(([,p])=>p&&p.online).map(([id])=>id);
  await db.ref(`rooms/${roomId}`).update({ status:'drawing', currentRound:1, currentDrawer:players[0], currentWord:word, currentCategory:cat, roundStartTime:firebase.database.ServerValue.TIMESTAMP, correctGuessers:null, drawerOrder:players, drawerIndex:0, roundId:Date.now() });
  await Promise.all([ db.ref(`rooms/${roomId}/strokes`).remove(), db.ref(`rooms/${roomId}/chat`).remove() ]);
}

async function doNext(snap,cat,word) {
  const order=snap.drawerOrder||Object.keys(playersState);
  const ni=((snap.drawerIndex||0)+1)%order.length;
  const nr=(snap.currentRound||1)+1;
  if(nr>MAX_ROUNDS){ await db.ref(`rooms/${roomId}`).update({status:'gameover'}); return; }
  await db.ref(`rooms/${roomId}`).update({ status:'drawing', currentRound:nr, currentDrawer:order[ni], currentWord:word, currentCategory:cat, roundStartTime:firebase.database.ServerValue.TIMESTAMP, correctGuessers:null, drawerIndex:ni, roundId:Date.now() });
  await Promise.all([ db.ref(`rooms/${roomId}/strokes`).remove(), db.ref(`rooms/${roomId}/chat`).remove() ]);
}

/* ============================================================ ENTER GAME */
function enterGame() {
  clearListeners();
  showScreen('game-screen');
  initCanvas();
  // Listen room
  addListener(db.ref(`rooms/${roomId}`),'value',snap=>{
    const data=snap.val(); if(!data) return;
    const newRoundId=data.roundId;
    // ‚≠ê Clear canvas when round changes
    if(newRoundId && newRoundId!==prevRoundId && prevRoundId!==null) {
      clearCanvas();
    }
    prevRoundId=newRoundId;
    gameState=data; playersState=data.players||{};
    isDrawer=data.currentDrawer===playerId;
    currentWord=data.currentWord||''; currentCategory=data.currentCategory||'';
    renderUI(data);
    if(data.status==='drawing'){ document.getElementById('phase-overlay').classList.add('hidden'); startTimer(data.roundStartTime); }
    else if(data.status==='round_end'){ stopTimer(); showRoundEnd(data); }
    else if(data.status==='gameover'){ stopTimer(); showGameOver(data); }
  });
  // Listen strokes
  strokesRef=db.ref(`rooms/${roomId}/strokes`);
  addListener(strokesRef,'child_added',snap=>{ const s=snap.val(); if(s) drawStroke(s); });
  // Listen chat
  addListener(db.ref(`rooms/${roomId}/chat`),'child_added',snap=>{ const m=snap.val(); if(m) appendMsg(m); });
}

/* ============================================================ RENDER UI */
function renderUI(data) {
  document.getElementById('round-label').textContent=`Ronde ${data.currentRound||1}/${MAX_ROUNDS}`;
  document.getElementById('category-label').textContent=data.currentCategory||'‚Äî';
  const dn=(playersState[data.currentDrawer]||{}).name||'?';
  document.getElementById('topbar-drawer-label').textContent=isDrawer?'üñåÔ∏è Kamu menggambar!':`üñåÔ∏è ${escHtml(dn)} menggambar`;

  const wb=document.getElementById('drawer-word-bar');
  if(isDrawer&&data.currentWord){ wb.style.display='block'; wb.textContent=`ü§´ ${data.currentWord}`; }
  else wb.style.display='none';

  if(!isDrawer&&data.currentWord&&data.status==='drawing') renderHint(data.currentWord,data.correctGuessers||{});
  else document.getElementById('word-hint-bar').innerHTML='';

  const tb=document.getElementById('draw-toolbar');
  tb.style.opacity=isDrawer?'1':'0.35'; tb.style.pointerEvents=isDrawer?'auto':'none';
  if(canvas) canvas.style.cursor=isDrawer?'crosshair':'default';

  renderScoreboard(data);
}

function renderHint(word,cg) {
  const bar=document.getElementById('word-hint-bar'); bar.innerHTML='';
  const did=cg[playerId];
  for(let i=0;i<word.length;i++){
    const s=document.createElement('span');
    if(word[i]===' '){ s.className='hint-letter'; s.style.width='14px'; s.textContent=' '; }
    else { s.className='hint-letter'+(did?' revealed':''); s.textContent=did?word[i]:'_'; }
    bar.appendChild(s);
  }
}

function renderScoreboard(data) {
  const list=document.getElementById('game-player-list'); list.innerHTML='';
  Object.entries(playersState).filter(([,p])=>p).sort((a,b)=>(b[1].score||0)-(a[1].score||0)).forEach(([pid,p])=>{
    const d=document.createElement('div'); d.className='player-row';
    const col=avatarColor(p.name||'?');
    d.innerHTML=`${pid===data.currentDrawer?'<div class="drawer-indicator"></div>':''}<div class="avatar" style="background:${col}20;color:${col};">${initials(p.name||'?')}</div><div class="pinfo"><div class="pname">${escHtml(p.name)}</div></div><div class="pscore">${p.score||0}</div>`;
    list.appendChild(d);
  });
}

/* ============================================================ ROUND END / GAME OVER */
let cdInterval=null;
function showRoundEnd(data) {
  const ov=document.getElementById('phase-overlay'); ov.classList.remove('hidden');
  document.getElementById('phase-title').textContent='‚è±Ô∏è Ronde Selesai!';
  document.getElementById('phase-sub').textContent='Kata yang benar:';
  const pw=document.getElementById('phase-word'); pw.textContent=data.currentWord||''; pw.style.display='block';
  let sec=Math.ceil(ROUND_END_DELAY/1000);
  const cd=document.getElementById('phase-countdown'); cd.textContent=`Ronde berikutnya dalam ${sec}s‚Ä¶`;
  if(cdInterval) clearInterval(cdInterval);
  cdInterval=setInterval(()=>{ sec--; if(sec<=0){clearInterval(cdInterval);cd.textContent='';} else cd.textContent=`Ronde berikutnya dalam ${sec}s‚Ä¶`; },1000);
  if(isHost) setTimeout(()=>{
    db.ref(`rooms/${roomId}`).once('value',snap=>{ const d=snap.val(); if(d&&d.status==='round_end'){ pendingSnap=d; pickerCtx='next'; openPicker(); }});
  }, ROUND_END_DELAY);
}

function showGameOver(data) {
  if(cdInterval) clearInterval(cdInterval);
  const ov=document.getElementById('phase-overlay'); ov.classList.remove('hidden');
  document.getElementById('phase-title').textContent='üèÜ Game Selesai!';
  document.getElementById('phase-word').style.display='none';
  document.getElementById('phase-countdown').textContent='';
  const sorted=Object.entries(playersState).filter(([,p])=>p).sort((a,b)=>(b[1].score||0)-(a[1].score||0));
  const medals=['ü•á','ü•à','ü•â'];
  document.getElementById('phase-sub').innerHTML=
    sorted.slice(0,5).map(([,p],i)=>`${medals[i]||'  '} <strong>${escHtml(p.name)}</strong>: ${p.score||0} poin`).join('<br>')
    +(isHost?`<br><br><button class="btn btn-green" style="margin-top:10px;padding:10px 20px;" onclick="restartGame()">üîÑ Main Lagi</button>`:'');
}

window.restartGame=async function() {
  const ups={}; Object.keys(playersState).forEach(pid=>{ ups[`players/${pid}/score`]=0; });
  await db.ref(`rooms/${roomId}`).update({status:'waiting',currentRound:0,...ups});
  await Promise.all([db.ref(`rooms/${roomId}/strokes`).remove(),db.ref(`rooms/${roomId}/chat`).remove()]);
  clearListeners(); prevRoundId=null; enterWaiting();
};

/* ============================================================ TIMER */
function startTimer(t) {
  stopTimer();
  const circ=document.getElementById('timer-circle'), num=document.getElementById('timer-number');
  const D=120;
  function tick(){
    if(!t) return;
    const rem=Math.max(0,ROUND_DURATION-Math.floor((Date.now()-t)/1000));
    num.textContent=rem;
    const pct=rem/ROUND_DURATION;
    circ.style.strokeDashoffset=D-pct*D;
    circ.style.stroke=pct>.4?'var(--accent)':pct>.2?'var(--gold)':'var(--accent2)';
    if(rem<=0){ stopTimer(); if(isHost) db.ref(`rooms/${roomId}`).once('value',snap=>{ const d=snap.val(); if(d&&d.status==='drawing') db.ref(`rooms/${roomId}/status`).set('round_end'); }); }
  }
  timerInterval=setInterval(tick,500); tick();
}
function stopTimer(){ if(timerInterval){clearInterval(timerInterval);timerInterval=null;} }

/* ============================================================ CANVAS */
function initCanvas() {
  canvas=document.getElementById('game-canvas'); ctx=canvas.getContext('2d');
  prevRoundId=null;
  resizeCanvas();
  window.addEventListener('resize',resizeCanvas);

  canvas.addEventListener('mousedown',e=>startDraw(e));
  canvas.addEventListener('mousemove',e=>moveDraw(e));
  canvas.addEventListener('mouseup',()=>endDraw());
  canvas.addEventListener('mouseleave',()=>endDraw());
  canvas.addEventListener('touchstart',e=>{e.preventDefault();startDraw(e.touches[0]);},{passive:false});
  canvas.addEventListener('touchmove',e=>{e.preventDefault();moveDraw(e.touches[0]);},{passive:false});
  canvas.addEventListener('touchend',()=>endDraw());

  document.querySelectorAll('.color-swatch').forEach(sw=>{
    sw.addEventListener('click',()=>{
      document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('active'));
      sw.classList.add('active'); curColor=sw.dataset.color; isEraser=false;
      document.getElementById('eraser-btn').classList.remove('active');
    });
  });
  document.getElementById('eraser-btn').addEventListener('click',()=>{ isEraser=!isEraser; document.getElementById('eraser-btn').classList.toggle('active',isEraser); });
  document.getElementById('size-slider').addEventListener('input',e=>{ brushSize=parseInt(e.target.value); });
  document.getElementById('clear-btn').addEventListener('click',()=>{ if(!isDrawer) return; clearCanvas(); db.ref(`rooms/${roomId}/strokes`).remove(); });
}

function clearCanvas() {
  if(!ctx||!canvas) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#1a1d26'; ctx.fillRect(0,0,canvas.width,canvas.height);
  const wrap=document.getElementById('canvas-wrap');
  wrap.classList.add('wiping'); setTimeout(()=>wrap.classList.remove('wiping'),400);
}

function resizeCanvas() {
  if(!canvas) return;
  const r=document.getElementById('canvas-wrap').getBoundingClientRect();
  const img=ctx&&canvas.width>0?ctx.getImageData(0,0,canvas.width,canvas.height):null;
  canvas.width=Math.floor(r.width); canvas.height=Math.floor(r.height);
  ctx.fillStyle='#1a1d26'; ctx.fillRect(0,0,canvas.width,canvas.height);
  if(img) ctx.putImageData(img,0,0);
}

function getPos(e) {
  const r=canvas.getBoundingClientRect();
  return { x:Math.max(0,Math.min(1,(e.clientX-r.left)/canvas.width)), y:Math.max(0,Math.min(1,(e.clientY-r.top)/canvas.height)) };
}

function startDraw(e){ if(!isDrawer) return; painting=true; const p=getPos(e); sendStroke(p.x,p.y,'start'); }
function moveDraw(e){ if(!isDrawer||!painting) return; const p=getPos(e); sendStroke(p.x,p.y,'move'); }
function endDraw(){ if(!painting) return; painting=false; sendStroke(0,0,'end'); }

function sendStroke(x,y,state) {
  if(!strokesRef) return;
  strokesRef.push({ x,y,state,color:isEraser?null:curColor,size:brushSize,eraser:isEraser,ts:Date.now() });
}

function drawStroke(s) {
  if(!ctx||!canvas) return;
  const px=s.x*canvas.width, py=s.y*canvas.height;
  const col=s.eraser?'#1a1d26':(s.color||'#ffffff');
  if(s.state==='start'){
    ctx.beginPath(); ctx.moveTo(px,py);
    ctx.strokeStyle=col; ctx.lineWidth=s.size; ctx.lineCap='round'; ctx.lineJoin='round';
  } else if(s.state==='move'){
    ctx.strokeStyle=col; ctx.lineWidth=s.size; ctx.lineCap='round'; ctx.lineJoin='round';
    ctx.lineTo(px,py); ctx.stroke(); ctx.beginPath(); ctx.moveTo(px,py);
  }
}

/* ============================================================ CHAT */
document.getElementById('btn-send-chat').addEventListener('click',sendChat);
document.getElementById('chat-input').addEventListener('keydown',e=>{ if(e.key==='Enter') sendChat(); });

async function sendChat() {
  const inp=document.getElementById('chat-input');
  const msg=inp.value.trim(); if(!msg) return;
  const now=Date.now();
  if(now-lastChat<CHAT_COOLDOWN){ appendLocal('‚è≥ Tunggu sebentar dulu!'); return; }
  lastChat=now; inp.value='';

  if(gameState.status!=='drawing'){ appendLocal('‚õî Game tidak sedang berlangsung.'); return; }

  if(isDrawer){
    await db.ref(`rooms/${roomId}/chat`).push({ playerId,playerName,message:msg,timestamp:firebase.database.ServerValue.TIMESTAMP,isCorrect:false,isSystem:false });
    return;
  }

  if(gameState.correctGuessers&&gameState.correctGuessers[playerId]){ appendLocal('‚úÖ Kamu sudah menebak!'); return; }

  const correct=msg.toLowerCase().trim()===currentWord.toLowerCase().trim();
  await db.ref(`rooms/${roomId}/chat`).push({ playerId,playerName,message:correct?`‚úÖ ${playerName} menebak dengan benar!`:msg,timestamp:firebase.database.ServerValue.TIMESTAMP,isCorrect:correct,isSystem:correct });

  if(correct){
    await db.ref(`rooms/${roomId}/correctGuessers/${playerId}`).set(true);
    await db.ref(`rooms/${roomId}/players/${playerId}/score`).transaction(s=>(s||0)+10);
    await db.ref(`rooms/${roomId}/players/${gameState.currentDrawer}/score`).transaction(s=>(s||0)+5);
    document.getElementById('canvas-wrap').classList.add('flash');
    setTimeout(()=>document.getElementById('canvas-wrap').classList.remove('flash'),700);
    const nonDrawers=Object.entries(playersState).filter(([pid,p])=>p&&p.online&&pid!==gameState.currentDrawer);
    const nc=Object.keys({...(gameState.correctGuessers||{}),[playerId]:true});
    if(isHost&&nc.length>=nonDrawers.length) await db.ref(`rooms/${roomId}/status`).set('round_end');
  }
}

function appendMsg(msg) {
  const box=document.getElementById('chat-messages');
  const d=document.createElement('div');
  d.className='chat-msg'+(msg.isCorrect?' correct':'')+(msg.isSystem?' system':'');
  if(msg.isSystem){ d.textContent=msg.message; }
  else {
    const sp=document.createElement('span'); sp.className='cn'; sp.style.color=avatarColor(msg.playerName||'?'); sp.textContent=(msg.playerName||'?')+':';
    d.appendChild(sp); d.appendChild(document.createTextNode(' '+msg.message));
  }
  box.appendChild(d); box.scrollTop=box.scrollHeight;
}
function appendLocal(txt){ const box=document.getElementById('chat-messages'); const d=document.createElement('div'); d.className='chat-msg system'; d.textContent=txt; box.appendChild(d); box.scrollTop=box.scrollHeight; }

/* ============================================================ BOOT */
window.addEventListener('load', initFirebase);
</script>
</body>
</html>
